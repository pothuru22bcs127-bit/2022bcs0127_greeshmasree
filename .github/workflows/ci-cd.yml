name: CI/CD for ML Inference

on:
  push:
    branches:
      - main

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirement.txt

      - name: Train model
        run: |
          python scripts/train.py
          echo "===== METRICS ====="
          cat metrics.json

      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            model.pkl
            metrics.json

  deploy:
    runs-on: ubuntu-latest
    needs: train

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq & bc
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Download model artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: artifacts

      - name: Compare metrics
        run: |
          BEST=0
          CURRENT=$(jq .r2 artifacts/metrics.json)  # match metric name in metrics.json

          echo "Best metric   : $BEST"
          echo "Current metric: $CURRENT"

          if (( $(echo "$CURRENT <= $BEST" | bc -l) )); then
            echo "Metric did not improve. Skipping deployment."
            exit 0
          fi

          echo "Metric improved. Proceeding to deploy."
          echo "current_metric=$CURRENT" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Prepare Docker build context
        run: cp artifacts/model.pkl .  # include trained model

      - name: Build and push Docker image
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/wine-api:latest \
            -t ${{ secrets.DOCKER_USERNAME }}/wine-api:${GITHUB_SHA} .

          docker push ${{ secrets.DOCKER_USERNAME }}/wine-api:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/wine-api:${GITHUB_SHA}
